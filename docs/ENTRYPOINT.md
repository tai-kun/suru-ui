# 感じていること・考えていること

## 課題の認識と取り巻く状況の変化

従来、HTML 要素で発生するあらゆるイベントは React のライフサイクルが管理し、API を通じて JavaScript で (ほぼ) 完全に制御されてきた。コードが状態を従い、目の前のコードがすべてであるという設計は、Web アプリケーションをコードで明白に理解できる一方で、不必要に複雑化してしまう問題を抱えている。開発者ツールを使わない限りは意図した動作を (後方互換性も含めて) 保証するための策と解釈することで納得できるが、Web にはすでに標準機能としてフォーム検証が存在し、今後は最上位レイヤーや Popover API、CSS Anchor Positioning など、JavaScript で表現・制御 (開閉やアクセシビリティ、フォーカストラップなど) してきた一部の機能も標準になろうとしている。

## React の鞘に収まりたい

ちまちま useState したり Context.Provider で放り投げられたバケツに収集をつけるのがやや億劫に思う。これらの機能は必須だが、完全に制御しようとするとあまりにも多く記述しなければならない。現状多くの UI コンポーネントライブラリはフレームワークと強く結びつきすぎているものの、[htmx](https://htmx.org/) のように振り切れない。React の鞘に収まりたい。

このような経緯と個人的なお気持ちから、通常は見捨てられることのない後方互換性とともに広域なプラットフォームのサポートや JavaScript による完全な制御を諦め、ブラウザのイベントにある程度身を任せた UI コンポーネントを検討したい。つまりこれまで React で従えてきたすべてを部分的に React 側が従うようにする。

## ステートマシンによる制御

JavaScript による完全な制御を諦めることはすなわち標準 API の利用許可を得たということだが、その場合コンポーネントの props に絶対的な支配権は無く、こうあったらいいな程度の弱い意味しか持たない場面がでてくるため、ブラウザのイベントに身を任せつつ props の要求にも可能な限り対応するコストが重くなってくる。そこで props の変更もある種の cancelable なイベントとみなして標準 API のイベントとともにステートマシンによる状態遷移の定義へ落とし込み、制御できるか実験する。

ステートマシンは有名なところだと [Chakra UI](https://chakra-ui.com/) が提供する [Zag](https://zagjs.com/) で活用されている。Zag の場合は React 以外にも Vue や Solid といった異なるフレームワーク間の違いを吸収するのがステートマシンを使う動機になっているようだが、論理的に異なる文脈で発生するイベントに従う状態遷移の表現という意味では、今回のケースにもうまく当てはまってくれるだろうと考える。

ステートマシンのライブラリを探して `xstate@5.9.1` か `@zag-js/core@0.38.0` を検討したが、`createMachine` のみを利用した場合のバンドルサイズ (minified + gzipped) がそれぞれ [14 KB](https://shakerphobia.netlify.app/?imports=createMachine&pkg=xstate%405.9.1) と [5.5 KB](https://shakerphobia.netlify.app/?imports=createMachine&pkg=%40zag-js%2Fcore%400.38.0) で少し大きいと感じた。実際には React 用のライブラリも別途インストールする必要があるので、もっと大きくなることを考えると、React に特化してより軽量 (1 KB) な [`@cassiozen/usestatemachine`](https://github.com/cassiozen/useStateMachine) を採用したい。ただしこちらは最新リリースの 2022 年 1 月 15 日から 2 年以上も空いているので、メンテナンスされていないと判断。フォークしてリファクタリングして React の必須条件を 16.8 以降から 18 以降へ引き上げることでいくつかの新機能を追加し [`tai-kun/useStateMachine`](https://github.com/tai-kun/useStateMachine) ([npm](https://www.npmjs.com/package/@tai-kun/use-state-machine)) として公開する。全機能を ESM でバンドルした場合のサイズは 1.5 KB (minified + gzipped) 未満になったので、満足してこちらを使っていくことにする。

## さいごに

今回の実験を通して、ブラウザのイベントに身を任せた UI コンポーネント開発の可能性を探り、従来の React 開発と比較検討することで、より単純で効率的な開発方法を見つけたい。
